<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Copper Bus Simulator — 3D + Heatmap (iOS-safe)</title>
<style>
  :root{--bg:#0e0f12;--card:#171a20;--ink:#e6e7ea;--muted:#9aa0a6;--accent:#4da3ff}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;overflow-x:hidden}
  header{padding:16px 20px;position:sticky;top:0;z-index:3;background:linear-gradient(180deg,rgba(23,26,32,.9),rgba(23,26,32,.6) 60%,rgba(23,26,32,0));border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:saturate(1.2) blur(8px)}
  h1{font-size:20px;margin:0 0 2px}.sub{color:var(--muted);font-size:13px}
  main{padding:20px;max-width:1100px;margin:auto;display:grid;gap:18px;grid-template-columns:1.05fr .95fr}
  @media (max-width:1040px){main{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:680px){.grid{grid-template-columns:1fr}}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  .row{display:flex;gap:10px;align-items:center}
  .row input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0c0d10;color:var(--ink);font-size:14px}
  .units{white-space:nowrap;color:var(--muted);font-size:12px}
  .switch{display:inline-flex;gap:8px;align-items:center;background:#0c0d10;border:1px solid rgba(255,255,255,.06);padding:4px;border-radius:999px}
  .switch button{border:0;background:transparent;color:var(--muted);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px}
  .switch button.active{background:var(--accent);color:#05152a}
  .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .kpi .item{background:#0c0d10;border-radius:12px;border:1px solid rgba(255,255,255,.06);padding:12px}
  .kpi .label{color:var(--muted);font-size:12px}.kpi .value{font-size:20px;font-weight:650;margin-top:2px}
  .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
  /* 3D panel: fixed CSS height – JS only scales pixels, never CSS size */
  .view3d{height:420px;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:#0a0b0e;position:relative;overflow:hidden}
  @media (max-width:520px){.view3d{height:340px}}
  #gl,#fallback{display:block;width:100%;height:100%}
  .overlay{position:absolute;right:10px;top:10px;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:10px;font-size:12px;color:var(--muted);backdrop-filter:blur(6px)}
  .note{position:absolute;left:10px;top:10px;background:#2a1f14;border:1px solid #6a3a1e;color:#ffc89b;border-radius:8px;padding:6px 10px;font-size:12px;display:none}
  /* Heatmap wrapper prevents iOS resize feedback */
  .heatwrap{width:100%;aspect-ratio:16/9;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:#0a0b0e;overflow:hidden}
  .heatwrap canvas{width:100%;height:100%;display:block}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>Copper Bus Simulator — 3D + Heatmap</h1>
  <div class="sub">3-D view with live skin-effect heatmap. Stable on iOS; WebGL fallback included.</div>
</header>

<main>
  <section class="card">
    <div class="grid">
      <div>
        <div class="row">
          <label>Geometry units</label>
          <div class="switch">
            <button id="u_in" class="active" onclick="setUnits('in')">in</button>
            <button id="u_mm" onclick="setUnits('mm')">mm</button>
          </div>
        </div>
        <label>Conductor geometry (rectangular bar)</label>
        <div class="row"><input id="width" type="number" step="0.001" min="0.001" value="1.00"><span id="uw" class="units">in</span></div>
        <div class="row"><input id="thickness" type="number" step="0.001" min="0.001" value="0.25"><span id="ut" class="units">in</span></div>
        <div class="row"><input id="length" type="number" step="0.01" min="0.01" value="8.0"><span id="ul" class="units">ft</span></div>

        <div class="hr"></div>
        <label>Electrical conditions</label>
        <div class="row"><input id="current" type="number" step="0.1" min="0" value="500.0"><span class="units">A RMS</span></div>
        <div class="row"><input id="freq" type="number" step="1" min="0" value="100000"><span class="units">Hz</span></div>
        <div class="row"><input id="voltage" type="number" step="0.1" min="0" placeholder="(optional)"><span class="units">V (for % drop)</span></div>

        <div class="hr"></div>
        <label>Copper properties</label>
        <div class="row"><input id="temp" type="number" step="0.1" value="20.0"><span class="units">°C</span></div>
        <div class="hint">ρ<sub>20°C</sub> = 1.724×10⁻⁸ Ω·m, α = 0.00393/°C. μ ≈ μ₀.</div>
      </div>

      <div>
        <div class="kpi">
          <div class="item"><div class="label">Cross-sectional area (DC)</div><div class="value"><span id="areaDC">—</span> <span class="units">mm²</span></div></div>
          <div class="item"><div class="label">Skin depth δ</div><div class="value"><span id="delta">—</span> <span class="units">mm</span></div></div>
          <div class="item"><div class="label">R<sub>DC</sub></div><div class="value"><span id="rdc">—</span> <span class="units">mΩ</span></div></div>
          <div class="item"><div class="label">R<sub>AC</sub> (approx)</div><div class="value"><span id="rac">—</span> <span class="units">mΩ</span></div></div>
          <div class="item"><div class="label">Current density (AC eff.)</div><div class="value"><span id="j">—</span> <span class="units">A/mm²</span></div></div>
          <div class="item"><div class="label">I²R loss (AC)</div><div class="value"><span id="loss">—</span> <span class="units">W</span></div></div>
          <div class="item"><div class="label">Voltage drop (AC)</div><div class="value"><span id="vdrop">—</span> <span class="units">V</span></div></div>
          <div class="item"><div class="label">R<sub>AC</sub>/R<sub>DC</sub></div><div class="value"><span id="kac">—</span></div></div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="grid">
      <div>
        <div class="view3d" id="view3d">
          <canvas id="gl"></canvas>
          <canvas id="fallback"></canvas>
          <div class="overlay">drag to rotate • scroll/pinch to zoom</div>
          <div id="glmsg" class="note">WebGL unavailable — showing 2-D preview</div>
        </div>
        <div class="hint">3-D uses WebGL; if blocked, a 2-D shaded preview appears. (Proximity effects not modeled yet.)</div>
      </div>
      <div>
        <h3 style="margin:0 0 8px">Projected hotspots (cross-section)</h3>
        <div class="heatwrap"><canvas id="heat" aria-label="Hotspot heatmap"></canvas></div>
        <div class="hint">Colors show relative RMS current density; ∬J dA = I. For t ≫ 2δ, outer skins run hottest.</div>
      </div>
    </div>
  </section>
</main>

<script>
/* ---------- constants & helpers ---------- */
const RHO20=1.724e-8, ALPHA=0.00393, MU0=4e-7*Math.PI; let unit='in';
function setUnits(u){unit=u;document.getElementById('u_in').classList.toggle('active',u==='in');document.getElementById('u_mm').classList.toggle('active',u==='mm');document.getElementById('uw').textContent=(u==='in')?'in':'mm';document.getElementById('ut').textContent=(u==='in')?'in':'mm';document.getElementById('ul').textContent=(u==='in')?'ft':'m';recompute();}
function toMeters(x,k){if(!(x>0))return 0;return k==='length'?(unit==='in'?x*0.3048:x):(unit==='in'?x*0.0254:x/1000);}
function areaMM2(m2){return m2*1e6} function format(x,d=3){if(!isFinite(x))return'—';const a=Math.abs(x);return (a>=1000||a<0.01)?x.toExponential(d-1):x.toFixed(d)}

/* ---------- heatmap ---------- */
function colormap(a){a=Math.min(1,Math.max(0,a));if(a<0.33){const t=a/0.33;return[26+t*(50-26)|0,70+t*(216-70)|0,255]}else if(a<0.66){const t=(a-0.33)/0.33;return[50+t*(255-50)|0,216+t*(194-216)|0,255+t*(45-255)|0]}else{const t=(a-0.66)/0.34;return[255,194+t*(45-194)|0,45]}}
function drawHeatmap(ctx,w,t,delta,I){
  const dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
  const rect=ctx.canvas.getBoundingClientRect();
  const W=Math.max(1,Math.floor(rect.width*dpr)), H=Math.max(1,Math.floor(rect.height*dpr));
  if(ctx.canvas.width!==W||ctx.canvas.height!==H){ctx.canvas.width=W;ctx.canvas.height=H;}
  ctx.fillStyle='#0a0b0e';ctx.fillRect(0,0,W,H);
  const pad=10, availW=W-2*pad, availH=H-2*pad, ar=w/t;
  let dW,dH; if(availW/availH>ar){dH=availH;dW=dH*ar;} else {dW=availW;dH=dW/ar;}
  const x0=(W-dW)/2, y0=(H-dH)/2, Nx=Math.max(40,Math.floor(dW)), Ny=Math.max(40,Math.floor(dH));
  const dx=w/Nx, dy=t/Ny, invDelta=(delta>0)?1/delta:0, thinBlend=(t>0&&isFinite(invDelta))?Math.min(1,t/(2*delta)):0;
  let maxJ=0,sumJ=0; const img=ctx.createImageData(Nx,Ny), Jvals=new Float32Array(Nx*Ny);
  for(let iy=0;iy<Ny;iy++){const y=(iy+0.5)*dy, Jv=(thinBlend===0)?1:(Math.exp(-y*invDelta)+Math.exp(-(t-y)*invDelta));
    for(let ix=0;ix<Nx;ix++){const Jraw=(1-thinBlend)*1+thinBlend*Jv;Jvals[iy*Nx+ix]=Jraw;maxJ=Math.max(maxJ,Jraw);sumJ+=Jraw;}}
  const scale=(sumJ*dx*dy>0)?I/(sumJ*dx*dy):0; // (kept for completeness)
  for(let iy=0;iy<Ny;iy++){for(let ix=0;ix<Nx;ix++){const a=(maxJ>0)?(Jvals[iy*Nx+ix]/maxJ):0;const [r,g,b]=colormap(a);const p=((Ny-1-iy)*Nx+ix)*4;img.data[p]=r;img.data[p+1]=g;img.data[p+2]=b;img.data[p+3]=255;}}
  const tmp=document.createElement('canvas'); tmp.width=Nx; tmp.height=Ny; tmp.getContext('2d').putImageData(img,0,0);
  ctx.imageSmoothingEnabled=false; ctx.drawImage(tmp,x0,y0,dW,dH); ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2; ctx.strokeRect(x0,y0,dW,dH);
  return tmp;
}

/* ---------- 3D (WebGL) with graceful fallback ---------- */
let gl,prog,buffers={},u={},tex,rot=mat4Identity(),distance=2.8,lastX=0,lastY=0,drag=false, webglOK=false;
function tryGetGL(canvas){
  try{ return canvas.getContext('webgl',{antialias:true,alpha:false}) || canvas.getContext('experimental-webgl'); }
  catch(e){ return null; }
}
function init3D(){
  const glCanvas=document.getElementById('gl');
  const fbCanvas=document.getElementById('fallback');
  const msg=document.getElementById('glmsg');

  gl=tryGetGL(glCanvas);
  webglOK=!!gl;

  if(!webglOK){
    // Show fallback 2-D pseudo-3D and a small note
    msg.style.display='block';
    fbCanvas.style.display='block';
    glCanvas.style.display='none';
    drawFallback();  // simple isometric box with heat texture on top
    return;
  }
  // Hide fallback
  msg.style.display='none';
  fbCanvas.style.display='none';
  glCanvas.style.display='block';

  // Shaders
  const vs=`attribute vec3 aPos;attribute vec3 aNormal;attribute vec2 aUV;uniform mat4 uMVP;uniform mat4 uModel;varying vec3 vN;varying vec2 vUV;void main(){vN=mat3(uModel)*aNormal;vUV=aUV;gl_Position=uMVP*vec4(aPos,1.0);}`;
  const fs=`precision mediump float;varying vec3 vN;varying vec2 vUV;uniform sampler2D uTex;uniform vec3 uLightDir;void main(){vec3 N=normalize(vN);float ndl=max(dot(N,normalize(uLightDir)),0.0);vec3 tex=texture2D(uTex,vUV).rgb;float shade=0.35+0.65*ndl;gl_FragColor=vec4(tex*shade,1.0);}`;
  prog=link(gl,vs,fs); gl.useProgram(prog);
  u.mvp=gl.getUniformLocation(prog,'uMVP'); u.model=gl.getUniformLocation(prog,'uModel'); u.tex=gl.getUniformLocation(prog,'uTex'); u.light=gl.getUniformLocation(prog,'uLightDir');

  // Backing-store sizing only (no CSS changes -> no layout feedback)
  function sizeBacking(){
    const dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
    const r=glCanvas.getBoundingClientRect();
    const W=Math.max(1,Math.floor(r.width*dpr)), H=Math.max(1,Math.floor(r.height*dpr));
    if(glCanvas.width!==W||glCanvas.height!==H){glCanvas.width=W;glCanvas.height=H;gl.viewport(0,0,W,H);requestAnimationFrame(drawGL);}
  }
  sizeBacking();
  window.addEventListener('resize',sizeBacking,{passive:true});
  window.addEventListener('orientationchange',sizeBacking,{passive:true});

  // Interactions
  const view=document.getElementById('view3d');
  view.addEventListener('mousedown',e=>{drag=true;lastX=e.clientX;lastY=e.clientY;});
  window.addEventListener('mouseup',()=>drag=false);
  window.addEventListener('mousemove',e=>{if(!drag)return;const dx=(e.clientX-lastX)/200,dy=(e.clientY-lastY)/200;lastX=e.clientX;lastY=e.clientY;rot=mat4Mul(rot,mat4RotateY(dx));rot=mat4Mul(rot,mat4RotateX(dy));requestAnimationFrame(drawGL);});
  view.addEventListener('wheel',e=>{e.preventDefault();distance*=(1+Math.sign(e.deltaY)*0.08);distance=Math.max(0.8,Math.min(8.0,distance));requestAnimationFrame(drawGL);},{passive:false});
}
function buildBox(L,W,T){
  const hx=L/2,hy=T/2,hz=W/2;
  const P=[-hx,hy,-hz,0,1,0,0,0,  hx,hy,-hz,0,1,0,1,0,  hx,hy,hz,0,1,0,1,1,  -hx,hy,hz,0,1,0,0,1,
           -hx,-hy,hz,0,-1,0,0,0,  hx,-hy,hz,0,-1,0,1,0,  hx,-hy,-hz,0,-1,0,1,1,  -hx,-hy,-hz,0,-1,0,0,1,
            hx,-hy,-hz,1,0,0,0,0,  hx,hy,-hz,1,0,0,1,0,  hx,hy,hz,1,0,0,1,1,  hx,-hy,hz,1,0,0,0,1,
           -hx,-hy,hz,-1,0,0,0,0, -hx,hy,hz,-1,0,0,1,0, -hx,hy,-hz,-1,0,0,1,1, -hx,-hy,-hz,-1,0,0,0,1,
           -hx,-hy,hz,0,0,1,0,0,  hx,-hy,hz,0,0,1,1,0,  hx,hy,hz,0,0,1,1,1,  -hx,hy,hz,0,0,1,0,1,
            hx,-hy,-hz,0,0,-1,0,0, -hx,-hy,-hz,0,0,-1,1,0, -hx,hy,-hz,0,0,-1,1,1,  hx,hy,-hz,0,0,-1,0,1 ];
  const I=[0,1,2,0,2,3, 4,5,6,4,6,7, 8,9,10,8,10,11, 12,13,14,12,14,15, 16,17,18,16,18,19, 20,21,22,20,22,23];
  if(buffers.vbo){gl.deleteBuffer(buffers.vbo);gl.deleteBuffer(buffers.ibo);}
  buffers.vbo=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buffers.vbo); gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(P),gl.STATIC_DRAW);
  buffers.ibo=gl.createBuffer(); gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,buffers.ibo); gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(I),gl.STATIC_DRAW);
  const stride=(3+3+2)*4, aPos=gl.getAttribLocation(prog,'aPos'), aN=gl.getAttribLocation(prog,'aNormal'), aUV=gl.getAttribLocation(prog,'aUV');
  gl.vertexAttribPointer(aPos,3,gl.FLOAT,false,stride,0); gl.enableVertexAttribArray(aPos);
  gl.vertexAttribPointer(aN,3,gl.FLOAT,false,stride,3*4); gl.enableVertexAttribArray(aN);
  gl.vertexAttribPointer(aUV,2,gl.FLOAT,false,stride,6*4); gl.enableVertexAttribArray(aUV);
  buffers.count=I.length;
}
function updateTextureFromCanvas(c){
  if(!tex){tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);}
  gl.bindTexture(gl.TEXTURE_2D,tex); gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true); gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c);
}
function drawGL(){
  gl.enable(gl.DEPTH_TEST); gl.clearColor(0.04,0.05,0.07,1); gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);
  const cvs=document.getElementById('gl'); const aspect=cvs.width/cvs.height;
  const P=mat4Perspective(45*Math.PI/180,aspect,0.05,50), V=mat4LookAt([0,0,distance],[0,0,0],[1,0,0].slice(0,0).concat(0)); // quick lookAt below
  const eye=[0,0,distance], center=[0,0,0], up=[0,1,0]; const V2=mat4LookAt(eye,center,up);
  const MVP=mat4Mul(mat4Mul(P,V2),rot);
  gl.useProgram(prog); gl.uniformMatrix4fv(u.mvp,false,MVP); gl.uniformMatrix4fv(u.model,false,rot); gl.uniform3f(u.light,0.7,0.9,0.3);
  gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D,tex); gl.uniform1i(u.tex,0);
  gl.bindBuffer(gl.ARRAY_BUFFER,buffers.vbo); gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,buffers.ibo);
  gl.drawElements(gl.TRIANGLES,buffers.count,gl.UNSIGNED_SHORT,0);
}

/* tiny mats */
function mat4Identity(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}
function mat4Mul(a,b){const r=new Array(16);for(let i=0;i<4;i++)for(let j=0;j<4;j++){r[i*4+j]=0;for(let k=0;k<4;k++)r[i*4+j]+=a[i*4+k]*b[k*4+j]}return r}
function mat4RotateX(a){const c=Math.cos(a),s=Math.sin(a);return[1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1]}
function mat4RotateY(a){const c=Math.cos(a),s=Math.sin(a);return[c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1]}
function mat4Perspective(fovy,aspect,near,far){const f=1/Math.tan(fovy/2),nf=1/(near-far);return[f/aspect,0,0,0,0,f,0,0,0,0,(far+near)*nf,-1,0,0,(2*far*near)*nf,0]}
function mat4LookAt(e,c,u){const zx=e[0]-c[0],zy=e[1]-c[1],zz=e[2]-c[2],zl=1/Math.hypot(zx,zy,zz),z=[zx*zl,zy*zl,zz*zl],xx=u[1]*z[2]-u[2]*z[1],xy=u[2]*z[0]-u[0]*z[2],xz=u[0]*z[1]-u[1]*z[0],xl=1/Math.hypot(xx,xy,xz),x=[xx*xl,xy*xl,xz*xl],y=[z[1]*x[2]-z[2]*x[1],z[2]*x[0]-z[0]*x[2],z[0]*x[1]-z[1]*x[0]];return[x[0],y[0],z[0],0,x[1],y[1],z[1],0,x[2],y[2],z[2],0,-(x[0]*e[0]+x[1]*e[1]+x[2]*e[2]),-(y[0]*e[0]+y[1]*e[1]+y[2]*e[2]),-(z[0]*e[0]+z[1]*e[1]+z[2]*e[2]),1]}

/* 2-D fallback preview */
function drawFallback(){
  const cv=document.getElementById('fallback'); const ctx=cv.getContext('2d');
  const dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1)); const r=cv.getBoundingClientRect();
  const W=Math.max(1,Math.floor(r.width*dpr)), H=Math.max(1,Math.floor(r.height*dpr));
  if(cv.width!==W||cv.height!==H){cv.width=W;cv.height=H;}
  ctx.clearRect(0,0,W,H);
  // simple shaded box
  const gx=10, gy=40, L=W-20, T=Math.min(80,H-80), Wz=Math.min(60,H-100);
  ctx.fillStyle='#3a2a14'; ctx.fillRect(gx,gy,L,T);
  const grad=ctx.createLinearGradient(0,gy,0,gy+T); grad.addColorStop(0,'#ff6a3a'); grad.addColorStop(.05,'#ffd66a'); grad.addColorStop(.2,'#32d8ff'); grad.addColorStop(1,'#1a46ff');
  ctx.fillStyle=grad; ctx.fillRect(gx,gy, L, 12); // hot top "skin"
  ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(gx,gy+T,L,1);
}

/* ---------- compute ---------- */
function recompute(){
  const w_in=+document.getElementById('width').value, t_in=+document.getElementById('thickness').value, L_in=+document.getElementById('length').value;
  const I=+document.getElementById('current').value, f=+document.getElementById('freq').value, Vsup=+document.getElementById('voltage').value, T=+document.getElementById('temp').value;
  if(!(w_in>0&&t_in>0&&L_in>0&&f>=0&&I>=0))return;
  const w=toMeters(w_in,'geom'), t=toMeters(t_in,'geom'), L=toMeters(L_in,'length');
  const rho=RHO20*(1+ALPHA*(T-20)), A_dc=w*t, area_dc_mm2=areaMM2(A_dc);
  const omega=2*Math.PI*f, delta=(f>0)?Math.sqrt(2*rho/(MU0*omega)):1e9;
  const A_eff=(f<=0||t<=2*delta)?A_dc:2*w*delta;
  const R_dc=rho*L/A_dc, R_ac=rho*L/A_eff, J_eff=(A_eff>0)?I/A_eff:0, P=I*I*R_ac, Vdrop=I*R_ac, kac=R_ac/R_dc;

  areaDC.textContent=format(area_dc_mm2,3); deltaEl.textContent=format(delta*1000,3);
  rdc.textContent=format(R_dc*1000,3); rac.textContent=format(R_ac*1000,3); j.textContent=format(J_eff/1e6,3);
  loss.textContent=format(P,3); vdrop.textContent=format(Vdrop,3); kacEl.textContent=format(kac,3);

  const heatCtx=document.getElementById('heat').getContext('2d');
  const heatTex=drawHeatmap(heatCtx,w,t,delta,I);

  if(webglOK){
    const maxDim=Math.max(L,w,t), s=1.8/maxDim;
    buildBox(L*s,w*s,t*s);
    updateTextureFromCanvas(heatTex);
    requestAnimationFrame(drawGL);
  }else{
    drawFallback();
  }
}

/* DOM refs for KPIs (so closure minifies OK) */
const areaDC=document.getElementById('areaDC'), deltaEl=document.getElementById('delta'),
      rdc=document.getElementById('rdc'), rac=document.getElementById('rac'),
      j=document.getElementById('j'), loss=document.getElementById('loss'),
      vdrop=document.getElementById('vdrop'), kacEl=document.getElementById('kac');

/* shader linker */
function link(gl,vs,fs){function c(t,s){const sh=gl.createShader(t);gl.shaderSource(sh,s);gl.compileShader(sh);if(!gl.getShaderParameter(sh,gl.COMPILE_STATUS))console.error(gl.getShaderInfoLog(sh));return sh}
  const p=gl.createProgram(), v=c(gl.VERTEX_SHADER,vs), f=c(gl.FRAGMENT_SHADER,fs); gl.attachShader(p,v); gl.attachShader(p,f); gl.linkProgram(p);
  if(!gl.getProgramParameter(p,gl.LINK_STATUS))console.error(gl.getProgramInfoLog(p)); return p;}

/* init */
function init(){
  ['width','thickness','length','current','freq','voltage','temp'].forEach(id=>{const el=document.getElementById(id);el.addEventListener('input',recompute);el.addEventListener('change',recompute);});
  init3D();
  recompute();
}
window.addEventListener('DOMContentLoaded',init,{passive:true});
</script>
</body>
</html>